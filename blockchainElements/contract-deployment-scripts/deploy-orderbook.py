from web3 import Web3
import json
from web3.middleware import ExtraDataToPOAMiddleware
from time import sleep
import os
# Connect to PoA network
w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)

ACCOUNT = os.environ["ACCOUNT"]
KEYSTORE_FILE = os.environ["KEYSTORE_FILE"]
CONTRACT_ABI_PATH = os.environ["CONTRACT_ABI_PATH"]
KEYSTORE_PASSWORD = os.environ["KEYSTORE_PASSWORD"]
WEB3_PROVIDER = os.environ["WEB3_PROVIDER"]
w3 = Web3(Web3.HTTPProvider(WEB3_PROVIDER))
CHAIN_ID = os.environ["CHAIN_ID"]



if w3.is_connected():
    print("Connected to node!")
    print(f"Chain ID: {w3.eth.chain_id}")
    print(f"Block Number: {w3.eth.block_number}")
else:
    print("Failed to connect to node. Check if geth is running with --http on port 8545.")

with open(KEYSTORE_FILE) as f:
    keystore_json = json.load(f)
private_key = w3.eth.account.decrypt(keystore_json, KEYSTORE_PASSWORD)
account = w3.eth.account.from_key(private_key)

# Load ABI and bytecode
with open(CONTRACT_ABI_PATH) as f:
    abi = json.load(f)

contract_bytecode="0x608060405234801561001057600080fd5b50620f4240600560003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550612a79806100676000396000f3fe6080604052600436106100db576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806314dca602146100e05780632225cf311461010b57806325300a021461013657806327e235e31461016157806335cea2881461019e5780634a8393f3146101e05780636843e91d1461022257806381c1e27a1461025f57806398121e161461028857806398d5fdca146102b3578063c56c139a146102e0578063e0c5a27714610309578063e60c92cb14610334578063f8b2cb4f1461035d578063ffe43cda1461039a575b600080fd5b3480156100ec57600080fd5b506100f56103d7565b6040516101029190612745565b60405180910390f35b34801561011757600080fd5b506101206104e1565b60405161012d9190612944565b60405180910390f35b34801561014257600080fd5b5061014b61051d565b6040516101589190612944565b60405180910390f35b34801561016d57600080fd5b5061018860048036036101839190810190612300565b610523565b6040516101959190612944565b60405180910390f35b3480156101aa57600080fd5b506101c560048036036101c0919081019061238e565b61053b565b6040516101d7969594939291906126e4565b60405180910390f35b3480156101ec57600080fd5b506102076004803603610202919081019061238e565b6105c0565b604051610219969594939291906126e4565b60405180910390f35b34801561022e57600080fd5b5061024960048036036102449190810190612329565b610645565b6040516102569190612944565b60405180910390f35b34801561026b57600080fd5b50610286600480360361028191908101906123b7565b61065d565b005b34801561029457600080fd5b5061029d610883565b6040516102aa9190612944565b60405180910390f35b3480156102bf57600080fd5b506102c86108c0565b6040516102d79392919061295f565b60405180910390f35b3480156102ec57600080fd5b5061030760048036036103029190810190612352565b61093f565b005b34801561031557600080fd5b5061031e610c59565b60405161032b9190612745565b60405180910390f35b34801561034057600080fd5b5061035b60048036036103569190810190612300565b610d63565b005b34801561036957600080fd5b50610384600480360361037f9190810190612300565b610f22565b6040516103919190612944565b60405180910390f35b3480156103a657600080fd5b506103c160048036036103bc9190810190612329565b610f6b565b6040516103ce9190612944565b60405180910390f35b60606001805480602002602001604051908101604052809291908181526020016000905b828210156104d8578382906000526020600020906005020160c060405190810160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160018201548152602001600282015481526020016003820160009054906101000a900460ff161515151581526020016003820160019054906101000a900460ff16151515158152602001600482015481525050815260200190600101906103fb565b50505050905090565b600080600080549050116104f6576000610518565b60008081548110151561050557fe5b9060005260206000209060050201600201545b905090565b60025481565b60056020528060005260406000206000915090505481565b60008181548110151561054a57fe5b90600052602060002090600502016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010154908060020154908060030160009054906101000a900460ff16908060030160019054906101000a900460ff16908060040154905086565b6001818154811015156105cf57fe5b90600052602060002090600502016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010154908060020154908060030160009054906101000a900460ff16908060030160019054906101000a900460ff16908060040154905086565b60046020528060005260406000206000915090505481565b6000600560003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205414156106ed57620f4240600560003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055505b60003342868686604051602001808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166c0100000000000000000000000002815260140185815260200184815260200183815260200182151515157f0100000000000000000000000000000000000000000000000000000000000000028152600101955050505050506040516020818303038152906040528051906020012090506107a161225c565b60c0604051908101604052803373ffffffffffffffffffffffffffffffffffffffff16815260200187815260200186815260200185151581526020018415158152602001838152509050831561080d576000816020015111156108085761080781610f83565b5b610825565b60008160200151111561082457610823816112ca565b5b5b3373ffffffffffffffffffffffffffffffffffffffff167f0f7404c19164d134e0e9581de7a35b626eaa498d65f446df57600c9c2d240525858888868860405161087395949392919061279e565b60405180910390a2505050505050565b600080600180549050116108985760006108bb565b600160008154811015156108a857fe5b9060005260206000209060050201600201545b905090565b600080600080600080549050116108d85760006108fa565b6000808154811015156108e757fe5b9060005260206000209060050201600201545b9250600060018054905011610910576000610933565b6001600081548110151561092057fe5b9060005260206000209060050201600201545b91506002549050909192565b8015610acf57600060036000848152602001908152602001600020549050600080549050811015156109a6576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161099d90612884565b60405180910390fd5b3373ffffffffffffffffffffffffffffffffffffffff166000828154811015156109cc57fe5b906000526020600020906005020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141515610a56576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a4d90612924565b60405180910390fd5b610a5f81611631565b60036000848152602001908152602001600020600090553373ffffffffffffffffffffffffffffffffffffffff167f20715c248187126678e628a0aa43090d1f9750ad72e3b52140d9e6f72cafd2b460018386604051610ac193929190612767565b60405180910390a250610c55565b60006004600084815260200190815260200160002054905060018054905081101515610b30576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b2790612884565b60405180910390fd5b3373ffffffffffffffffffffffffffffffffffffffff16600182815481101515610b5657fe5b906000526020600020906005020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141515610be0576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bd790612924565b60405180910390fd5b610be9816118c0565b60046000848152602001908152602001600020600090553373ffffffffffffffffffffffffffffffffffffffff167f20715c248187126678e628a0aa43090d1f9750ad72e3b52140d9e6f72cafd2b460008386604051610c4b93929190612767565b60405180910390a2505b5050565b60606000805480602002602001604051908101604052809291908181526020016000905b82821015610d5a578382906000526020600020906005020160c060405190810160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160018201548152602001600282015481526020016003820160009054906101000a900460ff161515151581526020016003820160019054906101000a900460ff1615151515815260200160048201548152505081526020019060010190610c7d565b50505050905090565b8073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610dd3576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610dca90612864565b60405180910390fd5b6000808054905090505b6000811115610e78578173ffffffffffffffffffffffffffffffffffffffff16600060018303815481101515610e0f57fe5b906000526020600020906005020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415610e6a57610e6960018203611631565b5b808060019003915050610ddd565b50600060018054905090505b6000811115610f1e578173ffffffffffffffffffffffffffffffffffffffff166001808303815481101515610eb557fe5b906000526020600020906005020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415610f1057610f0f600182036118c0565b5b808060019003915050610e84565b5050565b6000600560008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60036020528060005260406000206000915090505481565b80606001511515610fc9576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610fc090612844565b60405180910390fd5b60008090505b60018054905081108015610fe7575060008260200151115b156112a1576000600182815481101515610ffd57fe5b9060005260206000209060050201905082608001518061102557508060020154836040015110155b15611293576000836020015182600101541161104557816001015461104b565b83602001515b905060008260020154820290508060056000876000015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054101515156110e0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016110d7906128a4565b60405180910390fd5b8060056000876000015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254039250508190555080600560008560000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055508260000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16856000015173ffffffffffffffffffffffffffffffffffffffff167f4fdfb4bc5c3d7954bf0b952cd054a593aac25ab20128ee363ad8f47ec6be6c648760a0015186600401548688600201548760405161123b9594939291906127f1565b60405180910390a382600201546002819055508183600101600082825403925050819055508185602001818151039150818152505060008360010154141561129057611286846118c0565b8380600190039450505b50505b508080600101915050610fcf565b50600081602001511180156112b857508060800151155b156112c7576112c681611b4f565b5b50565b8060600151151515611311576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611308906128c4565b60405180910390fd5b60008090505b6000805490508110801561132f575060008260200151115b15611608576000808281548110151561134457fe5b9060005260206000209060050201905082608001518061136c57508060020154836040015111155b156115fa576000836020015182600101541161138c578160010154611392565b83602001515b9050600082600201548202905080600560008560000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205410151515611447576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161143e90612904565b60405180910390fd5b80600560008560000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825403925050819055508060056000876000015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282540192505081905550846000015173ffffffffffffffffffffffffffffffffffffffff168360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f4fdfb4bc5c3d7954bf0b952cd054a593aac25ab20128ee363ad8f47ec6be6c6485600401548860a00151868860020154876040516115a29594939291906127f1565b60405180910390a38260020154600281905550818360010160008282540392505081905550818560200181815103915081815250506000836001015414156115f7576115ed84611631565b8380600190039450505b50505b508080600101915050611317565b506000816020015111801561161f57508060800151155b1561162e5761162d81611ed6565b5b50565b6000805490508110151561167a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611671906128e4565b60405180910390fd5b6000808281548110151561168a57fe5b906000526020600020906005020160040154905060008290505b600160008054905003811015611817576000600182018154811015156116c657fe5b90600052602060002090600502016000828154811015156116e357fe5b90600052602060002090600502016000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060018201548160010155600282015481600201556003820160009054906101000a900460ff168160030160006101000a81548160ff0219169083151502179055506003820160019054906101000a900460ff168160030160016101000a81548160ff02191690831515021790555060048201548160040155905050806003600080848154811015156117e657fe5b90600052602060002090600502016004015481526020019081526020016000208190555080806001019150506116a4565b506000805480151561182557fe5b6001900381819060005260206000209060050201600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000905560028201600090556003820160006101000a81549060ff02191690556003820160016101000a81549060ff021916905560048201600090555050905560036000828152602001908152602001600020600090555050565b60018054905081101515611909576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611900906128e4565b60405180910390fd5b600060018281548110151561191a57fe5b906000526020600020906005020160040154905060008290505b6001808054905003811015611aa657600180820181548110151561195457fe5b906000526020600020906005020160018281548110151561197157fe5b90600052602060002090600502016000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060018201548160010155600282015481600201556003820160009054906101000a900460ff168160030160006101000a81548160ff0219169083151502179055506003820160019054906101000a900460ff168160030160016101000a81548160ff021916908315150217905550600482015481600401559050508060046000600184815481101515611a7557fe5b9060005260206000209060050201600401548152602001908152602001600020819055508080600101915050611934565b5060018054801515611ab457fe5b6001900381819060005260206000209060050201600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000905560028201600090556003820160006101000a81549060ff02191690556003820160016101000a81549060ff021916905560048201600090555050905560046000828152602001908152602001600020600090555050565b60008090505b60008054905081108015611b8d5750600081815481101515611b7357fe5b906000526020600020906005020160020154826040015111155b15611b9f578080600101915050611b55565b6000829080600181540180825580915050906001820390600052602060002090600502016000909192909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff02191690831515021790555060808201518160030160016101000a81548160ff02191690831515021790555060a08201518160040155505050600060016000805490500390505b81811115611def57600060018203815481101515611c9d57fe5b9060005260206000209060050201600082815481101515611cba57fe5b90600052602060002090600502016000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060018201548160010155600282015481600201556003820160009054906101000a900460ff168160030160006101000a81548160ff0219169083151502179055506003820160019054906101000a900460ff168160030160016101000a81548160ff0219169083151502179055506004820154816004015590505080600360008084815481101515611dbd57fe5b906000526020600020906005020160040154815260200190815260200160002081905550808060019003915050611c83565b5081600082815481101515611e0057fe5b906000526020600020906005020160008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff02191690831515021790555060808201518160030160016101000a81548160ff02191690831515021790555060a0820151816004015590505080600360008460a001518152602001908152602001600020819055505050565b60008090505b60018054905081108015611f145750600181815481101515611efa57fe5b906000526020600020906005020160020154826040015110155b15611f26578080600101915050611edc565b6001829080600181540180825580915050906001820390600052602060002090600502016000909192909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff02191690831515021790555060808201518160030160016101000a81548160ff02191690831515021790555060a082015181600401555050506000600180805490500390505b8181111561217557600180820381548110151561202257fe5b906000526020600020906005020160018281548110151561203f57fe5b90600052602060002090600502016000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060018201548160010155600282015481600201556003820160009054906101000a900460ff168160030160006101000a81548160ff0219169083151502179055506003820160019054906101000a900460ff168160030160016101000a81548160ff02191690831515021790555060048201548160040155905050806004600060018481548110151561214357fe5b906000526020600020906005020160040154815260200190815260200160002081905550808060019003915050612009565b508160018281548110151561218657fe5b906000526020600020906005020160008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff02191690831515021790555060808201518160030160016101000a81548160ff02191690831515021790555060a0820151816004015590505080600460008460a001518152602001908152602001600020819055505050565b60c060405190810160405280600073ffffffffffffffffffffffffffffffffffffffff1681526020016000815260200160008152602001600015158152602001600015158152602001600080191681525090565b60006122bc8235612a0d565b905092915050565b60006122d08235612a1f565b905092915050565b60006122e48235612a2b565b905092915050565b60006122f88235612a35565b905092915050565b60006020828403121561231257600080fd5b6000612320848285016122b0565b91505092915050565b60006020828403121561233b57600080fd5b6000612349848285016122d8565b91505092915050565b6000806040838503121561236557600080fd5b6000612373858286016122d8565b9250506020612384858286016122c4565b9150509250929050565b6000602082840312156123a057600080fd5b60006123ae848285016122ec565b91505092915050565b600080600080608085870312156123cd57600080fd5b60006123db878288016122ec565b94505060206123ec878288016122ec565b93505060406123fd878288016122c4565b925050606061240e878288016122c4565b91505092959194509250565b612423816129bb565b82525050565b6000612434826129a3565b80845260208401935061244683612996565b60005b828110156124785761245c86835161265a565b612465826129ae565b915060c086019550600181019050612449565b50849250505092915050565b61248d816129cd565b82525050565b61249c816129d9565b82525050565b6000601382527f4d757374206265206120627579206f72646572000000000000000000000000006020830152604082019050919050565b6000600c82527f556e617574686f72697a656400000000000000000000000000000000000000006020830152604082019050919050565b6000600d82527f496e76616c696420696e646578000000000000000000000000000000000000006020830152604082019050919050565b6000601482527f496e73756666696369656e742062616c616e63650000000000000000000000006020830152604082019050919050565b6000601482527f4d75737420626520612073656c6c206f726465720000000000000000000000006020830152604082019050919050565b6000601382527f496e646578206f7574206f6620626f756e6473000000000000000000000000006020830152604082019050919050565b6000601a82527f42757965722062616c616e636520696e73756666696369656e740000000000006020830152604082019050919050565b6000600e82527f4e6f7420796f7572206f726465720000000000000000000000000000000000006020830152604082019050919050565b60c082016000820151612670600085018261241a565b50602082015161268360208501826126d5565b50604082015161269660408501826126d5565b5060608201516126a96060850182612484565b5060808201516126bc6080850182612484565b5060a08201516126cf60a0850182612493565b50505050565b6126de81612a03565b82525050565b600060c0820190506126f9600083018961241a565b61270660208301886126d5565b61271360408301876126d5565b6127206060830186612484565b61272d6080830185612484565b61273a60a0830184612493565b979650505050505050565b6000602082019050818103600083015261275f8184612429565b905092915050565b600060608201905061277c6000830186612484565b61278960208301856126d5565b6127966040830184612493565b949350505050565b600060a0820190506127b36000830188612484565b6127c060208301876126d5565b6127cd60408301866126d5565b6127da6060830185612493565b6127e76080830184612484565b9695505050505050565b600060a0820190506128066000830188612493565b6128136020830187612493565b61282060408301866126d5565b61282d60608301856126d5565b61283a60808301846126d5565b9695505050505050565b6000602082019050818103600083015261285d816124a2565b9050919050565b6000602082019050818103600083015261287d816124d9565b9050919050565b6000602082019050818103600083015261289d81612510565b9050919050565b600060208201905081810360008301526128bd81612547565b9050919050565b600060208201905081810360008301526128dd8161257e565b9050919050565b600060208201905081810360008301526128fd816125b5565b9050919050565b6000602082019050818103600083015261291d816125ec565b9050919050565b6000602082019050818103600083015261293d81612623565b9050919050565b600060208201905061295960008301846126d5565b92915050565b600060608201905061297460008301866126d5565b61298160208301856126d5565b61298e60408301846126d5565b949350505050565b6000602082019050919050565b600081519050919050565b6000602082019050919050565b60006129c6826129e3565b9050919050565b60008115159050919050565b6000819050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b6000612a18826129e3565b9050919050565b60008115159050919050565b6000819050919050565b600081905091905056fea265627a7a7230582075883c8461cb95461ce4fa05509ec146e272f1d8f2f2be4e98ad1bcd6aa7f5696c6578706572696d656e74616cf50037"
contract = w3.eth.contract(abi=abi, bytecode=contract_bytecode)

def deploy_contract():
    print("\n--- Deploying TransferTester ---")
    try:
        # Build constructor transaction
        construct_txn = contract.constructor().build_transaction({
            'from': account.address,
            'nonce': w3.eth.get_transaction_count(account.address),
            'gas': 4000000,
            'gasPrice': w3.to_wei('1', 'gwei'),
            'chainId': int(CHAIN_ID)
        })
        
        # Sign and send transaction
        signed_txn = account.sign_transaction(construct_txn)
        tx_hash = w3.eth.send_raw_transaction(signed_txn.raw_transaction)
        print(f"Deployment transaction sent: {tx_hash.hex()}")
        
        # Wait for receipt
        receipt = w3.eth.wait_for_transaction_receipt(tx_hash)
        print(f"Deployed in block {receipt.blockNumber}")
        print(f"Contract address: {receipt.contractAddress}")
        print(f"Gas used: {receipt.gasUsed}")
        return receipt
    except Exception as e:
        print("Deployment failed:", str(e))
        return None


deploy_contract()
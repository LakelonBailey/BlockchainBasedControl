from web3 import Web3
import json
from web3.middleware import ExtraDataToPOAMiddleware
from time import sleep
import os
# Connect to PoA network
w3.middleware_onion.inject(ExtraDataToPOAMiddleware, layer=0)

ACCOUNT = os.environ["ACCOUNT"]
KEYSTORE_FILE = os.environ["KEYSTORE_FILE"]
CONTRACT_ABI_PATH = os.environ["CONTRACT_ABI_PATH"]
KEYSTORE_PASSWORD = os.environ["KEYSTORE_PASSWORD"]
WEB3_PROVIDER = os.environ["WEB3_PROVIDER"]
CONTRACT_ADDRESS = os.environ["CONTRACT_ADDRESS"]
w3 = Web3(Web3.HTTPProvider(WEB3_PROVIDER))




if w3.is_connected():
    print("Connected to node!")
    print(f"Chain ID: {w3.eth.chain_id}")
    print(f"Block Number: {w3.eth.block_number}")
else:
    print("Failed to connect to node. Check if geth is running with --http on port 8545.")

with open(KEYSTORE_FILE) as f:
    keystore_json = json.load(f)
private_key = w3.eth.account.decrypt(keystore_json, KEYSTORE_PASSWORD)
account = w3.eth.account.from_key(private_key)

# Load ABI and bytecode
with open(CONTRACT_ABI_PATH) as f:
    abi = json.load(f)

contract_bytecode = "0x608060405234801561001057600080fd5b50620f4240600560003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555061282f806100676000396000f3fe6080604052600436106100d0576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806314dca602146100d55780632225cf311461010057806325300a021461012b57806327e235e31461015657806335cea288146101935780634a8393f3146101d55780636843e91d1461021757806381c1e27a1461025457806398121e161461027d57806398d5fdca146102a8578063c56c139a146102d5578063e0c5a277146102fe578063f8b2cb4f14610329578063ffe43cda14610366575b600080fd5b3480156100e157600080fd5b506100ea6103a3565b6040516100f7919061251b565b60405180910390f35b34801561010c57600080fd5b506101156104ad565b60405161012291906126fa565b60405180910390f35b34801561013757600080fd5b506101406104e9565b60405161014d91906126fa565b60405180910390f35b34801561016257600080fd5b5061017d6004803603610178919081019061210d565b6104ef565b60405161018a91906126fa565b60405180910390f35b34801561019f57600080fd5b506101ba60048036036101b5919081019061219b565b610507565b6040516101cc969594939291906124ba565b60405180910390f35b3480156101e157600080fd5b506101fc60048036036101f7919081019061219b565b61058c565b60405161020e969594939291906124ba565b60405180910390f35b34801561022357600080fd5b5061023e60048036036102399190810190612136565b610611565b60405161024b91906126fa565b60405180910390f35b34801561026057600080fd5b5061027b600480360361027691908101906121c4565b610629565b005b34801561028957600080fd5b5061029261084f565b60405161029f91906126fa565b60405180910390f35b3480156102b457600080fd5b506102bd61088c565b6040516102cc93929190612715565b60405180910390f35b3480156102e157600080fd5b506102fc60048036036102f7919081019061215f565b61090b565b005b34801561030a57600080fd5b50610313610c25565b604051610320919061251b565b60405180910390f35b34801561033557600080fd5b50610350600480360361034b919081019061210d565b610d2f565b60405161035d91906126fa565b60405180910390f35b34801561037257600080fd5b5061038d60048036036103889190810190612136565b610d78565b60405161039a91906126fa565b60405180910390f35b60606001805480602002602001604051908101604052809291908181526020016000905b828210156104a4578382906000526020600020906005020160c060405190810160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160018201548152602001600282015481526020016003820160009054906101000a900460ff161515151581526020016003820160019054906101000a900460ff16151515158152602001600482015481525050815260200190600101906103c7565b50505050905090565b600080600080549050116104c25760006104e4565b6000808154811015156104d157fe5b9060005260206000209060050201600201545b905090565b60025481565b60056020528060005260406000206000915090505481565b60008181548110151561051657fe5b90600052602060002090600502016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010154908060020154908060030160009054906101000a900460ff16908060030160019054906101000a900460ff16908060040154905086565b60018181548110151561059b57fe5b90600052602060002090600502016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010154908060020154908060030160009054906101000a900460ff16908060030160019054906101000a900460ff16908060040154905086565b60046020528060005260406000206000915090505481565b6000600560003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205414156106b957620f4240600560003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055505b60003342868686604051602001808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166c0100000000000000000000000002815260140185815260200184815260200183815260200182151515157f01000000000000000000000000000000000000000000000000000000000000000281526001019550505050505060405160208183030381529060405280519060200120905061076d612069565b60c0604051908101604052803373ffffffffffffffffffffffffffffffffffffffff1681526020018781526020018681526020018515158152602001841515815260200183815250905083156107d9576000816020015111156107d4576107d381610d90565b5b6107f1565b6000816020015111156107f0576107ef816110d7565b5b5b3373ffffffffffffffffffffffffffffffffffffffff167f0f7404c19164d134e0e9581de7a35b626eaa498d65f446df57600c9c2d240525858888868860405161083f959493929190612574565b60405180910390a2505050505050565b60008060018054905011610864576000610887565b6001600081548110151561087457fe5b9060005260206000209060050201600201545b905090565b600080600080600080549050116108a45760006108c6565b6000808154811015156108b357fe5b9060005260206000209060050201600201545b92506000600180549050116108dc5760006108ff565b600160008154811015156108ec57fe5b9060005260206000209060050201600201545b91506002549050909192565b8015610a9b5760006003600084815260200190815260200160002054905060008054905081101515610972576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109699061263a565b60405180910390fd5b3373ffffffffffffffffffffffffffffffffffffffff1660008281548110151561099857fe5b906000526020600020906005020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141515610a22576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a19906126da565b60405180910390fd5b610a2b8161143e565b60036000848152602001908152602001600020600090553373ffffffffffffffffffffffffffffffffffffffff167f20715c248187126678e628a0aa43090d1f9750ad72e3b52140d9e6f72cafd2b460018386604051610a8d9392919061253d565b60405180910390a250610c21565b60006004600084815260200190815260200160002054905060018054905081101515610afc576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610af39061263a565b60405180910390fd5b3373ffffffffffffffffffffffffffffffffffffffff16600182815481101515610b2257fe5b906000526020600020906005020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141515610bac576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ba3906126da565b60405180910390fd5b610bb5816116cd565b60046000848152602001908152602001600020600090553373ffffffffffffffffffffffffffffffffffffffff167f20715c248187126678e628a0aa43090d1f9750ad72e3b52140d9e6f72cafd2b460008386604051610c179392919061253d565b60405180910390a2505b5050565b60606000805480602002602001604051908101604052809291908181526020016000905b82821015610d26578382906000526020600020906005020160c060405190810160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160018201548152602001600282015481526020016003820160009054906101000a900460ff161515151581526020016003820160019054906101000a900460ff1615151515815260200160048201548152505081526020019060010190610c49565b50505050905090565b6000600560008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60036020528060005260406000206000915090505481565b80606001511515610dd6576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610dcd9061261a565b60405180910390fd5b60008090505b60018054905081108015610df4575060008260200151115b156110ae576000600182815481101515610e0a57fe5b90600052602060002090600502019050826080015180610e3257508060020154836040015110155b156110a05760008360200151826001015411610e52578160010154610e58565b83602001515b905060008260020154820290508060056000876000015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205410151515610eed576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ee49061265a565b60405180910390fd5b8060056000876000015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254039250508190555080600560008560000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055508260000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16856000015173ffffffffffffffffffffffffffffffffffffffff167f4fdfb4bc5c3d7954bf0b952cd054a593aac25ab20128ee363ad8f47ec6be6c648760a001518660040154868860020154876040516110489594939291906125c7565b60405180910390a382600201546002819055508183600101600082825403925050819055508185602001818151039150818152505060008360010154141561109d57611093846116cd565b8380600190039450505b50505b508080600101915050610ddc565b50600081602001511180156110c557508060800151155b156110d4576110d38161195c565b5b50565b806060015115151561111e576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016111159061267a565b60405180910390fd5b60008090505b6000805490508110801561113c575060008260200151115b15611415576000808281548110151561115157fe5b9060005260206000209060050201905082608001518061117957508060020154836040015111155b15611407576000836020015182600101541161119957816001015461119f565b83602001515b9050600082600201548202905080600560008560000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205410151515611254576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161124b906126ba565b60405180910390fd5b80600560008560000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825403925050819055508060056000876000015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282540192505081905550846000015173ffffffffffffffffffffffffffffffffffffffff168360000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f4fdfb4bc5c3d7954bf0b952cd054a593aac25ab20128ee363ad8f47ec6be6c6485600401548860a00151868860020154876040516113af9594939291906125c7565b60405180910390a3826002015460028190555081836001016000828254039250508190555081856020018181510391508181525050600083600101541415611404576113fa8461143e565b8380600190039450505b50505b508080600101915050611124565b506000816020015111801561142c57508060800151155b1561143b5761143a81611ce3565b5b50565b60008054905081101515611487576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161147e9061269a565b60405180910390fd5b6000808281548110151561149757fe5b906000526020600020906005020160040154905060008290505b600160008054905003811015611624576000600182018154811015156114d357fe5b90600052602060002090600502016000828154811015156114f057fe5b90600052602060002090600502016000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060018201548160010155600282015481600201556003820160009054906101000a900460ff168160030160006101000a81548160ff0219169083151502179055506003820160019054906101000a900460ff168160030160016101000a81548160ff02191690831515021790555060048201548160040155905050806003600080848154811015156115f357fe5b90600052602060002090600502016004015481526020019081526020016000208190555080806001019150506114b1565b506000805480151561163257fe5b6001900381819060005260206000209060050201600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000905560028201600090556003820160006101000a81549060ff02191690556003820160016101000a81549060ff021916905560048201600090555050905560036000828152602001908152602001600020600090555050565b60018054905081101515611716576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161170d9061269a565b60405180910390fd5b600060018281548110151561172757fe5b906000526020600020906005020160040154905060008290505b60018080549050038110156118b357600180820181548110151561176157fe5b906000526020600020906005020160018281548110151561177e57fe5b90600052602060002090600502016000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060018201548160010155600282015481600201556003820160009054906101000a900460ff168160030160006101000a81548160ff0219169083151502179055506003820160019054906101000a900460ff168160030160016101000a81548160ff02191690831515021790555060048201548160040155905050806004600060018481548110151561188257fe5b9060005260206000209060050201600401548152602001908152602001600020819055508080600101915050611741565b50600180548015156118c157fe5b6001900381819060005260206000209060050201600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000905560028201600090556003820160006101000a81549060ff02191690556003820160016101000a81549060ff021916905560048201600090555050905560046000828152602001908152602001600020600090555050565b60008090505b6000805490508110801561199a575060008181548110151561198057fe5b906000526020600020906005020160020154826040015111155b156119ac578080600101915050611962565b6000829080600181540180825580915050906001820390600052602060002090600502016000909192909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff02191690831515021790555060808201518160030160016101000a81548160ff02191690831515021790555060a08201518160040155505050600060016000805490500390505b81811115611bfc57600060018203815481101515611aaa57fe5b9060005260206000209060050201600082815481101515611ac757fe5b90600052602060002090600502016000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060018201548160010155600282015481600201556003820160009054906101000a900460ff168160030160006101000a81548160ff0219169083151502179055506003820160019054906101000a900460ff168160030160016101000a81548160ff0219169083151502179055506004820154816004015590505080600360008084815481101515611bca57fe5b906000526020600020906005020160040154815260200190815260200160002081905550808060019003915050611a90565b5081600082815481101515611c0d57fe5b906000526020600020906005020160008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff02191690831515021790555060808201518160030160016101000a81548160ff02191690831515021790555060a0820151816004015590505080600360008460a001518152602001908152602001600020819055505050565b60008090505b60018054905081108015611d215750600181815481101515611d0757fe5b906000526020600020906005020160020154826040015110155b15611d33578080600101915050611ce9565b6001829080600181540180825580915050906001820390600052602060002090600502016000909192909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff02191690831515021790555060808201518160030160016101000a81548160ff02191690831515021790555060a082015181600401555050506000600180805490500390505b81811115611f82576001808203815481101515611e2f57fe5b9060005260206000209060050201600182815481101515611e4c57fe5b90600052602060002090600502016000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060018201548160010155600282015481600201556003820160009054906101000a900460ff168160030160006101000a81548160ff0219169083151502179055506003820160019054906101000a900460ff168160030160016101000a81548160ff021916908315150217905550600482015481600401559050508060046000600184815481101515611f5057fe5b906000526020600020906005020160040154815260200190815260200160002081905550808060019003915050611e16565b5081600182815481101515611f9357fe5b906000526020600020906005020160008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff02191690831515021790555060808201518160030160016101000a81548160ff02191690831515021790555060a0820151816004015590505080600460008460a001518152602001908152602001600020819055505050565b60c060405190810160405280600073ffffffffffffffffffffffffffffffffffffffff1681526020016000815260200160008152602001600015158152602001600015158152602001600080191681525090565b60006120c982356127c3565b905092915050565b60006120dd82356127d5565b905092915050565b60006120f182356127e1565b905092915050565b600061210582356127eb565b905092915050565b60006020828403121561211f57600080fd5b600061212d848285016120bd565b91505092915050565b60006020828403121561214857600080fd5b6000612156848285016120e5565b91505092915050565b6000806040838503121561217257600080fd5b6000612180858286016120e5565b9250506020612191858286016120d1565b9150509250929050565b6000602082840312156121ad57600080fd5b60006121bb848285016120f9565b91505092915050565b600080600080608085870312156121da57600080fd5b60006121e8878288016120f9565b94505060206121f9878288016120f9565b935050604061220a878288016120d1565b925050606061221b878288016120d1565b91505092959194509250565b61223081612771565b82525050565b600061224182612759565b8084526020840193506122538361274c565b60005b8281101561228557612269868351612430565b61227282612764565b915060c086019550600181019050612256565b50849250505092915050565b61229a81612783565b82525050565b6122a98161278f565b82525050565b6000601382527f4d757374206265206120627579206f72646572000000000000000000000000006020830152604082019050919050565b6000600d82527f496e76616c696420696e646578000000000000000000000000000000000000006020830152604082019050919050565b6000601482527f496e73756666696369656e742062616c616e63650000000000000000000000006020830152604082019050919050565b6000601482527f4d75737420626520612073656c6c206f726465720000000000000000000000006020830152604082019050919050565b6000601382527f496e646578206f7574206f6620626f756e6473000000000000000000000000006020830152604082019050919050565b6000601a82527f42757965722062616c616e636520696e73756666696369656e740000000000006020830152604082019050919050565b6000600e82527f4e6f7420796f7572206f726465720000000000000000000000000000000000006020830152604082019050919050565b60c0820160008201516124466000850182612227565b50602082015161245960208501826124ab565b50604082015161246c60408501826124ab565b50606082015161247f6060850182612291565b5060808201516124926080850182612291565b5060a08201516124a560a08501826122a0565b50505050565b6124b4816127b9565b82525050565b600060c0820190506124cf6000830189612227565b6124dc60208301886124ab565b6124e960408301876124ab565b6124f66060830186612291565b6125036080830185612291565b61251060a08301846122a0565b979650505050505050565b600060208201905081810360008301526125358184612236565b905092915050565b60006060820190506125526000830186612291565b61255f60208301856124ab565b61256c60408301846122a0565b949350505050565b600060a0820190506125896000830188612291565b61259660208301876124ab565b6125a360408301866124ab565b6125b060608301856122a0565b6125bd6080830184612291565b9695505050505050565b600060a0820190506125dc60008301886122a0565b6125e960208301876122a0565b6125f660408301866124ab565b61260360608301856124ab565b61261060808301846124ab565b9695505050505050565b60006020820190508181036000830152612633816122af565b9050919050565b60006020820190508181036000830152612653816122e6565b9050919050565b600060208201905081810360008301526126738161231d565b9050919050565b6000602082019050818103600083015261269381612354565b9050919050565b600060208201905081810360008301526126b38161238b565b9050919050565b600060208201905081810360008301526126d3816123c2565b9050919050565b600060208201905081810360008301526126f3816123f9565b9050919050565b600060208201905061270f60008301846124ab565b92915050565b600060608201905061272a60008301866124ab565b61273760208301856124ab565b61274460408301846124ab565b949350505050565b6000602082019050919050565b600081519050919050565b6000602082019050919050565b600061277c82612799565b9050919050565b60008115159050919050565b6000819050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60006127ce82612799565b9050919050565b60008115159050919050565b6000819050919050565b600081905091905056fea265627a7a72305820351b594a56ecfca4d3d8b6ffe64f73c7b6082756c002c4c0cbc63a4db9e404476c6578706572696d656e74616cf50037" 
contract = w3.eth.contract(abi=abi, bytecode=contract_bytecode)

def deploy_contract():
    print("\n--- Deploying TransferTester ---")
    try:
        # Build constructor transaction
        construct_txn = contract.constructor().build_transaction({
            'from': account.address,
            'nonce': w3.eth.get_transaction_count(account.address),
            'gas': 4000000,
            'gasPrice': w3.to_wei('1', 'gwei'),
            'chainId': 1340
        })
        
        # Sign and send transaction
        signed_txn = account.sign_transaction(construct_txn)
        tx_hash = w3.eth.send_raw_transaction(signed_txn.raw_transaction)
        print(f"Deployment transaction sent: {tx_hash.hex()}")
        
        # Wait for receipt
        receipt = w3.eth.wait_for_transaction_receipt(tx_hash)
        print(f"Deployed in block {receipt.blockNumber}")
        print(f"Contract address: {receipt.contractAddress}")
        print(f"Gas used: {receipt.gasUsed}")
        return receipt
    except Exception as e:
        print("Deployment failed:", str(e))
        return None


deploy_contract()